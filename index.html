<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Öğrenci Günlük Takip</title>
<style>
  body { font-family: Arial; background: #f6f6f6; padding: 20px; }
  .hidden { display: none; }
  input[type=number]{width:60px; margin:2px; }
  table{border-collapse: collapse; margin-top: 10px; background:#fff;}
  th, td { border:1px solid #ccc; padding:6px 8px; text-align:center; }
  .btn { padding:6px 12px; margin-top:8px; }
</style>
</head>
<body>

<h1>Öğrenci Günlük Takip</h1>

<div id="loginDiv">
  <h3>Giriş Yap</h3>
  <input id="username" placeholder="Kullanıcı Adı"><br><br>
  <input id="password" type="password" placeholder="Şifre"><br><br>
  <label><input type="checkbox" id="rememberMe"> Beni Hatırla</label><br><br>
  <button id="loginBtn" class="btn">Giriş</button>
  <p id="loginMsg" style="color:red"></p>
</div>

<div id="entryDiv" class="hidden">
  <div>Hoş geldin: <b id="who"></b> &nbsp; <button id="logoutBtn" class="btn">Çıkış</button></div>
  <h3>Doğru / Yanlış Girişi</h3>
  <table>
    <thead>
      <tr><th>Ders</th><th>Doğru</th><th>Yanlış</th></tr>
    </thead>
    <tbody id="entryTable"></tbody>
  </table>
  <button id="saveBtn" class="btn">Kaydet</button>
</div>

<div id="recordsDiv" class="hidden">
  <h3>Kayıtların</h3>
  <table id="recordsTable">
    <thead>
      <tr>
        <th>Tarih</th>
        <th>Türkçe D</th><th>Türkçe Y</th>
        <th>Mat D</th><th>Mat Y</th>
        <th>Sosyal D</th><th>Sosyal Y</th>
        <th>Fen D</th><th>Fen Y</th>
        <th>İng D</th><th>İng Y</th>
        <th>Din D</th><th>Din Y</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxXxpRIgP7f1aV6395qqO1b8wSGrf-zYxjKU6Y583BPNYt2QOb6_rEsra_kBlFU9jWlEA/exec';
const dersler = ['Türkçe','Matematik','Sosyal','Fen','İngilizce','Din'];

let sessionToken = null;
let currentUsername = null;

const loginDiv = document.getElementById('loginDiv');
const entryDiv = document.getElementById('entryDiv');
const recordsDiv = document.getElementById('recordsDiv');
const whoSpan = document.getElementById('who');

// Sayfa yüklendiğinde, önce localStorage’da hatırlanan kullanıcı var mı kontrol et
window.onload = function(){
  const savedUser = localStorage.getItem('savedUser');
  const savedPass = localStorage.getItem('savedPass');
  if(savedUser && savedPass){
    document.getElementById('username').value = savedUser;
    document.getElementById('password').value = savedPass;
    document.getElementById('rememberMe').checked = true;
  }
}

// login buton
document.getElementById('loginBtn').onclick = async function(){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const remember = document.getElementById('rememberMe').checked;
  document.getElementById('loginMsg').textContent = '';

  if(!username || !password){ document.getElementById('loginMsg').textContent = 'Kullanıcı adı ve şifre gerekli'; return; }

  const res = await fetch(WEB_APP_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'login', username, password})
  });
  const data = await res.json();
  if(data.status === 'ok'){
    sessionToken = data.token;
    currentUsername = data.username;
    loginDiv.classList.add('hidden');
    whoSpan.textContent = currentUsername;
    setupEntryForm();
    entryDiv.classList.remove('hidden');
    loadRecordsAndShow();
    // Hatırla seçili ise localStorage’a kaydet
    if(remember){
      localStorage.setItem('savedUser', username);
      localStorage.setItem('savedPass', password);
    } else {
      localStorage.removeItem('savedUser');
      localStorage.removeItem('savedPass');
    }
  } else {
    document.getElementById('loginMsg').textContent = data.message || 'Giriş hatası';
  }
};

// logout
document.getElementById('logoutBtn').onclick = function(){
  sessionToken = null;
  currentUsername = null;
  entryDiv.classList.add('hidden');
  recordsDiv.classList.add('hidden');
  loginDiv.classList.remove('hidden');
};

// entry form oluştur
function setupEntryForm(){
  const tbody = document.getElementById('entryTable');
  tbody.innerHTML = '';
  dersler.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d}</td>
      <td><input type="number" id="${d}_c" min="0" value="0"></td>
      <td><input type="number" id="${d}_w" min="0" value="0"></td>`;
    tbody.appendChild(tr);
  });
}

// save buton
document.getElementById('saveBtn').onclick = async function(){
  if(!sessionToken) { alert('Önce giriş yap'); return; }
  const tarih = new Date().toISOString().slice(0,10);
  const body = {action:'save', token: sessionToken, tarih: tarih};
  dersler.forEach(d => {
    body[camel(d+'_correct')] = Number(document.getElementById(d+'_c').value || 0);
    body[camel(d+'_wrong')] = Number(document.getElementById(d+'_w').value || 0);
  });

  const res = await fetch(WEB_APP_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if(data.status==='ok'){
    await loadRecordsAndShow();
    alert('Kayıt kaydedildi ve listelendi.');
  } else {
    alert('Kayıt hatası: '+(data.message||'Hata'));
  }
};

async function loadRecordsAndShow(){
  if(!sessionToken) return;
  const res = await fetch(WEB_APP_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'getRecords', token: sessionToken})
  });
  const data = await res.json();
  if(data.status==='ok'){
    const values = data.values || [];
    fillRecordsTable(values);
    recordsDiv.classList.remove('hidden');
  } else {
    alert('Kayıt getirilemedi: '+(data.message||'Hata'));
  }
}

function fillRecordsTable(values){
  const tbody = document.querySelector('#recordsTable tbody');
  tbody.innerHTML = '';
  if(!values || values.length<=1) return;
  for(let i=1;i<values.length;i++){
    const r = values[i];
    const tr = document.createElement('tr');
    const cells = [];
    cells.push(`<td>${r[0]||''}</td>`);
    for(let j=1;j<=12;j++) cells.push(`<td>${r[j]!==undefined?r[j]:''}</td>`);
    tr.innerHTML = cells.join('');
    tbody.appendChild(tr);
  }
}

function camel(s){
  const map={'Türkçe':'turkce','Matematik':'mat','Sosyal':'sosyal','Fen':'fen','İngilizce':'ing','Din':'din'};
  if(s.indexOf('_')===-1) return s;
  const parts = s.split('_');
  const ders = parts[0];
  const tail = parts[1];
  return (map[ders]||ders.toLowerCase())+'_'+tail;
}
</script>
</body>
</html>
