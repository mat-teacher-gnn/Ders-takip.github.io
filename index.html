<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>√ñƒürenci Takip - Geli≈ümi≈ü Giri≈ü</title>
<style>
  body{font-family:Arial, Helvetica, sans-serif;background:#121212;color:#eee;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{width:95%;max-width:760px;background:#1e1e1e;padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.6)}
  h1{color:#00c3ff;margin:0 0 12px 0;text-align:center}
  .row{display:flex;gap:8px;margin-bottom:8px}
  input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid #333;background:#222;color:#fff;font-size:15px;text-align:center}
  button{padding:10px 14px;border-radius:8px;border:none;background:#00c3ff;color:#041;cursor:pointer;font-weight:600}
  #loginMessage{color:#ffb3b3;margin-top:8px;text-align:center}
  #main{display:none;margin-top:12px}
  #tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .tab{background:#333;padding:8px 12px;border-radius:8px;cursor:pointer}
  .active{background:#00c3ff;color:#001}
  table{width:100%;border-collapse:collapse;margin:auto;background:#111;border-radius:8px;overflow:hidden}
  th,td{padding:8px;border:1px solid #222;text-align:center}
  th{background:#0b2540;color:#fff}
  input.table-input{width:100%;padding:6px;background:#222;border:none;color:#fff;text-align:center}
  #saveBtn{margin-top:10px;background:#29a329}
  #status{margin-top:8px;color:#bbb;font-size:13px;text-align:center}
</style>
</head>
<body>
  <div class="card">
    <h1>üîê √ñƒürenci Takip ‚Äî Giri≈ü</h1>

    <div id="loginBox">
      <div class="row">
        <input id="username" type="text" placeholder="Kullanƒ±cƒ± adƒ± (√∂r: Merve)"/>
        <input id="password" type="text" placeholder="≈ûifre (karakterler g√∂r√ºnecek)"/>
        <button id="loginBtn">Giri≈ü</button>
      </div>
      <div id="loginMessage"></div>
    </div>

    <div id="main">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div id="welcome" style="font-weight:700"></div>
        <div><button id="logoutBtn">√áƒ±kƒ±≈ü</button></div>
      </div>

      <div id="tabs" style="margin-top:12px">Y√ºkleniyor...</div>

      <div id="tableWrap">
        <table id="dataTable"></table>
        <div style="text-align:center">
          <button id="saveBtn" style="display:none">üíæ Kaydet</button>
        </div>
      </div>

      <div id="status"></div>
    </div>
  </div>

<script>
/*
  G√º√ßlendirilmi≈ü giri≈ü/y√ºkleme scripti
  - API_URL: senin Apps Script exec URL'in
  - Giri≈ü: "Kullanƒ±cƒ± Bilgileri" sekmesini √ßekip ba≈ülƒ±klardan esnek e≈üleme ile doƒürulama yapar.
  - Rol h√ºcresinde "hoca" (veya "teacher") yazarsa y√∂netici g√∂r√ºn√ºm√º a√ßƒ±lƒ±r.
*/
const API_URL = "https://script.google.com/macros/s/AKfycbwxkg567Zvpzn6zHCmGOsd7w6_Fw4NGrIbWcVAOT7pe_tTWuwi5xOjFZzg4c5h2hnowyw/exec";

const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMessage');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');

const mainDiv = document.getElementById('main');
const tabsDiv = document.getElementById('tabs');
const dataTable = document.getElementById('dataTable');
const saveBtn = document.getElementById('saveBtn');
const statusDiv = document.getElementById('status');
const welcomeDiv = document.getElementById('welcome');
const logoutBtn = document.getElementById('logoutBtn');

let currentUser = "";
let currentRole = "ogrenci";
let currentSheet = "";

// yardƒ±mcƒ±: API'den sheet verisini al (sheet param belirtilirse o sayfayƒ± d√∂ner)
async function fetchSheet(sheetName){
  const url = API_URL + (sheetName ? ("?sheet=" + encodeURIComponent(sheetName)) : "");
  const res = await fetch(url, {method:'GET'});
  if(!res.ok) throw new Error('HTTP ' + res.status);
  const json = await res.json();
  // json ya 2D array ya {headers, rows} veya hata mesajƒ± olabilir
  return json;
}

// yardƒ±mcƒ±: esnek ba≈ülƒ±k-e≈üleme
function headerIndex(headers, candidates){
  if(!headers) return -1;
  const low = headers.map(h => String(h||"").trim().toLowerCase());
  for(const cand of candidates){
    const idx = low.indexOf(cand.toLowerCase());
    if(idx >= 0) return idx;
  }
  return -1;
}

// giri≈ü mantƒ±ƒüƒ±
loginBtn.addEventListener('click', async ()=>{
  loginMsg.textContent = "";
  statusDiv.textContent = "";
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  if(!username || !password){
    loginMsg.textContent = "Kullanƒ±cƒ± adƒ± ve ≈üifre gerekli.";
    return;
  }

  loginBtn.disabled = true;
  loginMsg.textContent = "Kontrol ediliyor...";

  try {
    const data = await fetchSheet("Kullanƒ±cƒ± Bilgileri");

    // data 2D array veya {success, headers, rows}
    let headers = null, rows = null;
    if(Array.isArray(data)){
      headers = data[0] || [];
      rows = data.slice(1);
    } else if (data && data.headers && data.rows){
      headers = data.headers;
      rows = data.rows;
    } else {
      throw new Error("Kullanƒ±cƒ± Bilgileri okunamadƒ± (beklenmeyen format).");
    }

    // ba≈ülƒ±k indekslerini esnek al
    const nameIdx = headerIndex(headers, ["kullanƒ±cƒ± adƒ±","kullanici adi","kullanici adƒ±","username","user","isim","ad"]);
    const passIdx = headerIndex(headers, ["≈üifre","sifre","password","pass"]);
    const roleIdx = headerIndex(headers, ["rol","role","yetki","type","tip"]);

    if(nameIdx === -1 || passIdx === -1){
      throw new Error("Kullanƒ±cƒ± Bilgileri sayfasƒ±nda 'Kullanƒ±cƒ± Adƒ±' veya '≈ûifre' s√ºtunu bulunamadƒ±.");
    }

    // kullanƒ±cƒ±yƒ± ara
    let found = false;
    for(const r of rows){
      const n = String(r[nameIdx] || "").trim();
      const p = String(r[passIdx] || "").trim();
      if(n === username && p === password){
        found = true;
        // rol√º tespit et
        let roleVal = roleIdx !== -1 ? String(r[roleIdx]||"").trim().toLowerCase() : "";
        if(roleVal === "hoca" || roleVal === "teacher" || roleVal === "admin") currentRole = "hoca";
        else currentRole = "ogrenci";
        break;
      }
    }

    if(!found){
      loginMsg.textContent = "Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±.";
      loginBtn.disabled = false;
      return;
    }

    // ba≈üarƒ±lƒ±
    currentUser = username;
    welcomeDiv.textContent = `${currentUser} ‚Äî (${currentRole === 'hoca' ? 'Hoca' : '√ñƒürenci'})`;
    document.getElementById('loginBox').style.display = 'none';
    mainDiv.style.display = 'block';

    if(currentRole === 'hoca'){
      await loadAllTabs();
    } else {
      await loadSingleTab(currentUser);
    }

  } catch (err) {
    loginMsg.textContent = "Hata: " + err.message;
    console.error(err);
  } finally {
    loginBtn.disabled = false;
  }
});

// T√ºm sekmeleri getir ve g√∂ster (hoca)
async function loadAllTabs(){
  try {
    statusDiv.textContent = "Sekmeler y√ºkleniyor...";
    const res = await fetch(API_URL + "?mode=sheets");
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const names = await res.json();
    if(!Array.isArray(names)) throw new Error('Sekme listesi alƒ±namadƒ±');
    renderTabs(names);
    if(names.length) await loadSheet(names[0]);
    statusDiv.textContent = "";
  } catch (err){
    statusDiv.textContent = "Hata: " + err.message;
    console.error(err);
  }
}

// Sadece kendi sekmesini a√ß (√∂ƒürenci)
async function loadSingleTab(name){
  try {
    statusDiv.textContent = "Sayfa y√ºkleniyor...";
    // √∂nce sekme var mƒ± kontrol et
    const res = await fetch(API_URL + "?mode=sheets");
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const names = await res.json();
    const found = names && names.includes(name);
    if(!found) {
      // eƒüer yoksa doƒürudan aynƒ± ada yeni sekme olmasƒ±nƒ± bekleyebiliriz, ama √∂nce g√∂sterelim hata mesajƒ±
      statusDiv.textContent = `Kullanƒ±cƒ± adƒ±na uygun sayfa bulunamadƒ±: "${name}"`;
      renderTabs([]); // bo≈ü
      return;
    }
    renderTabs([name]);
    await loadSheet(name);
    statusDiv.textContent = "";
  } catch (err){
    statusDiv.textContent = "Hata: " + err.message;
    console.error(err);
  }
}

function renderTabs(names){
  tabsDiv.innerHTML = "";
  names.forEach((n, idx) => {
    const d = document.createElement('div');
    d.className = 'tab' + (idx===0? ' active':'');
    d.textContent = n;
    d.onclick = async ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      d.classList.add('active');
      await loadSheet(n);
    };
    tabsDiv.appendChild(d);
  });
}

// belirli bir sheet'i √ßek ve tabloya render et
async function loadSheet(sheetName){
  try {
    currentSheet = sheetName;
    statusDiv.textContent = `Y√ºkleniyor: ${sheetName} ...`;
    const payload = await fetchSheet(sheetName);
    // payload array mi yoksa object mi?
    let data = null;
    if(Array.isArray(payload)) data = payload;
    else if(payload && payload.success === false && payload.message) throw new Error(payload.message);
    else if(payload && payload.length === 0) data = payload;
    else if(payload && payload.headers && payload.rows) {
      // d√∂nm√º≈ü format: convert to 2D array
      data = [payload.headers].concat(payload.rows.map(r => payload.headers.map(h=> r[h]===undefined? "": r[h])));
    } else {
      // fallback: maybe it's JSON 2D already
      data = payload;
    }

    renderTableFrom2D(data);
    statusDiv.textContent = "";
  } catch (err){
    statusDiv.textContent = "Hata: " + err.message;
    console.error(err);
  }
}

// render a 2D array into table with input row at bottom
function renderTableFrom2D(data2d){
  dataTable.innerHTML = "";
  if(!data2d || data2d.length === 0){
    dataTable.innerHTML = "<tr><td>Veri yok</td></tr>";
    saveBtn.style.display = 'none';
    return;
  }

  // header
  const header = data2d[0];
  const thead = document.createElement('tr');
  header.forEach(h=>{
    const th = document.createElement('th'); th.textContent = h; thead.appendChild(th);
  });
  dataTable.appendChild(thead);

  // rows
  for(let i=1;i<data2d.length;i++){
    const tr = document.createElement('tr');
    data2d[i].forEach(cell=>{
      const td = document.createElement('td'); td.textContent = cell; tr.appendChild(td);
    });
    dataTable.appendChild(tr);
  }

  // input row
  const inRow = document.createElement('tr'); inRow.id = 'inputRow';
  header.forEach(_=>{
    const td = document.createElement('td');
    const inp = document.createElement('input'); inp.className='table-input';
    td.appendChild(inp); inRow.appendChild(td);
  });
  dataTable.appendChild(inRow);

  saveBtn.style.display = 'inline-block';
}

// kaydet fonksiyonu -> doPost append moduna uygun olarak √ßalƒ±≈üƒ±r
saveBtn.addEventListener('click', async ()=>{
  try {
    const inputs = Array.from(document.querySelectorAll('#inputRow input'));
    const vals = inputs.map(i => i.value.trim());
    if(vals.every(v => v === "")){
      alert('L√ºtfen en az bir h√ºcreye deƒüer girin.');
      return;
    }
    saveBtn.disabled = true; statusDiv.textContent = 'Kaydediliyor...';
    // POST form urlencoded (kod.gs instanceof doPost expects parameter mode=append, sheet, data JSON string)
    const body = new URLSearchParams();
    body.append('mode','append');
    body.append('sheet', currentSheet);
    body.append('data', JSON.stringify(vals));
    const res = await fetch(API_URL, { method:'POST', body });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    if(json && json.success){
      statusDiv.textContent = 'Kaydedildi.';
      // yenile
      await loadSheet(currentSheet);
    } else {
      throw new Error(json && (json.message || json.error) || 'Bilinmeyen hata');
    }
  } catch (err){
    statusDiv.textContent = 'Hata: ' + err.message;
    console.error(err);
  } finally {
    saveBtn.disabled = false;
  }
});

logoutBtn.addEventListener('click', ()=>{
  // basit √ßƒ±kƒ±≈ü -> sayfayƒ± yenile
  location.reload();
});

// otomatik olarak focus username
usernameInput.focus();
</script>
</body>
</html>
